<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema di Pagamento - CoWorking</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .test-button:hover {
            background: #0056b3;
        }

        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>üß™ Test Sistema di Pagamento</h1>

        <div class="test-section">
            <h3>1. Test Configurazione</h3>
            <button class="test-button" onclick="testConfig()">Test Configurazione</button>
            <div id="config-result"></div>
        </div>

        <div class="test-section">
            <h3>2. Test Autenticazione</h3>
            <button class="test-button" onclick="testAuth()">Test Autenticazione</button>
            <div id="auth-result"></div>
        </div>

        <div class="test-section">
            <h3>3. Test API Backend</h3>
            <button class="test-button" onclick="testBackend()">Test Backend</button>
            <div id="backend-result"></div>
        </div>

        <div class="test-section">
            <h3>4. Test Stripe</h3>
            <button class="test-button" onclick="testStripe()">Test Stripe</button>
            <div id="stripe-result"></div>
        </div>

        <div class="test-section">
            <h3>5. Test Completo Pagamento</h3>
            <button class="test-button" onclick="testCompletePayment()">Test Completo</button>
            <div id="complete-result"></div>
        </div>

        <div class="test-section">
            <h3>Log Test</h3>
            <div id="test-log"
                style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;">
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);

            const logDiv = document.getElementById('test-log');
            logDiv.innerHTML = testLog.map(entry => `<div>${entry}</div>`).join('');
            logDiv.scrollTop = logDiv.scrollHeight;

            console.log(logEntry);
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        // Test 1: Configurazione
        async function testConfig() {
            log('Iniziando test configurazione...');

            try {
                if (!window.CONFIG) {
                    throw new Error('Config non trovata');
                }

                const config = window.CONFIG;
                log(`Config trovata: ${JSON.stringify(config, null, 2)}`);

                if (config.API_BASE.includes('your-project')) {
                    showResult('config-result', '‚ö†Ô∏è Configurazione non personalizzata. Aggiorna config.js con i tuoi dati.', 'error');
                } else {
                    showResult('config-result', '‚úÖ Configurazione OK', 'success');
                }

            } catch (error) {
                log(`Errore configurazione: ${error.message}`);
                showResult('config-result', `‚ùå Errore: ${error.message}`, 'error');
            }
        }

        // Test 2: Autenticazione
        async function testAuth() {
            log('Iniziando test autenticazione...');

            try {
                const user = localStorage.getItem('user');
                if (!user) {
                    throw new Error('Utente non autenticato');
                }

                const userData = JSON.parse(user);
                log(`Utente autenticato: ${JSON.stringify(userData, null, 2)}`);

                if (userData.token) {
                    showResult('auth-result', '‚úÖ Utente autenticato con token', 'success');
                } else {
                    showResult('auth-result', '‚ö†Ô∏è Utente autenticato ma senza token', 'error');
                }

            } catch (error) {
                log(`Errore autenticazione: ${error.message}`);
                showResult('auth-result', `‚ùå Errore: ${error.message}`, 'error');
            }
        }

        // Test 3: Backend
        async function testBackend() {
            log('Iniziando test backend...');

            try {
                const response = await fetch(`${window.CONFIG.API_BASE}/ping`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log(`Backend risponde: ${JSON.stringify(data)}`);
                showResult('backend-result', '‚úÖ Backend raggiungibile', 'success');

            } catch (error) {
                log(`Errore backend: ${error.message}`);
                showResult('backend-result', `‚ùå Errore: ${error.message}`, 'error');
            }
        }

        // Test 4: Stripe
        async function testStripe() {
            log('Iniziando test Stripe...');

            try {
                const response = await fetch(`${window.CONFIG.API_BASE}/pagamenti/stripe/config`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const config = await response.json();
                log(`Config Stripe: ${JSON.stringify(config)}`);

                if (config.publishableKey) {
                    showResult('stripe-result', '‚úÖ Configurazione Stripe OK', 'success');
                } else {
                    showResult('stripe-result', '‚ö†Ô∏è Chiave pubblica Stripe mancante', 'error');
                }

            } catch (error) {
                log(`Errore Stripe: ${error.message}`);
                showResult('stripe-result', `‚ùå Errore: ${error.message}`, 'error');
            }
        }

        // Test 5: Pagamento completo
        async function testCompletePayment() {
            log('Iniziando test pagamento completo...');

            try {
                // Verifica autenticazione
                const user = localStorage.getItem('user');
                if (!user) {
                    throw new Error('Utente non autenticato');
                }

                const userData = JSON.parse(user);
                if (!userData.token) {
                    throw new Error('Token mancante');
                }

                log('‚úÖ Autenticazione verificata');

                // Verifica backend
                const pingResponse = await fetch(`${window.CONFIG.API_BASE}/ping`);
                if (!pingResponse.ok) {
                    throw new Error('Backend non raggiungibile');
                }

                log('‚úÖ Backend verificato');

                // Verifica Stripe
                const stripeResponse = await fetch(`${window.CONFIG.API_BASE}/pagamenti/stripe/config`);
                if (!stripeResponse.ok) {
                    throw new Error('Configurazione Stripe non disponibile');
                }

                const stripeConfig = await stripeResponse.json();
                if (!stripeConfig.publishableKey) {
                    throw new Error('Chiave pubblica Stripe mancante');
                }

                log('‚úÖ Stripe verificato');

                showResult('complete-result', '‚úÖ Tutti i test superati! Sistema pronto per i pagamenti.', 'success');

            } catch (error) {
                log(`Errore test completo: ${error.message}`);
                showResult('complete-result', `‚ùå Errore: ${error.message}`, 'error');
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function () {
            log('Pagina di test caricata');
            log(`Config API_BASE: ${window.CONFIG ? window.CONFIG.API_BASE : 'Non disponibile'}`);
        });
    </script>
</body>

</html>